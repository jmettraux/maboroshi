<!DOCTYPE html>

<html lang="en">

  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>å¹» maboroshi</title>

    <link href="css/maboroshi.css" rel="stylesheet" type="text/css" />

    <script src="js/h.min.js"></script>
    <script src="js/maboroshi.js"></script>
    <script src="js/qrcode.min.js"></script>
  </head>

  <body>

    <pre id="result">
    </pre>

    <div id="directory">
      <ul>
        <li><a href="/?table=monster0.md">monster0.md</a></li>
        <li><a href="/?table=monster1.md">npc0.md</a></li>
      </ul>
    </div>

    <div id="codes">
      <div class="self">
        <div class="code"></div>
        <div class="label">
          self
          <img src="images/copy.svg"></img>
        </div>
      </div>
      <div class="text">
        <div class="code"></div>
        <div class="label">
          text
          <img src="images/copy.svg"></img>
        </div>
      </div>
    </div>

    <script>

      var clog = console.log;
      var cerr = console.error;

      var roll = function(table) {

        table.roll()
          .then(function(r) {

            H.setText('#result', r);
            H.unhide('#result');

            //var qt = r
            //  .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            //  .slice(0, 4 * 1024);

            new QRCode(
              H.elt('#codes .text .code'),
              { text: r,
                width: 128,
                height: 128,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H });

            H.elt('#codes .text img[src="images/copy.svg"]')._text = r;
          });
      };

      H.onDocumentReady(function() {

        H.hide('#result');

        var ss = window.location.search
          .split(/[?&]/)
          .filter(function(e) { return e.length > 0; });
        var table = ss.find(function(e) { return e.match(/^table=.+/); });

        if (table) {

          H.hide('#directory');

          var u = decodeURIComponent(table.slice(6));

          MaboTableSet.make(u)
            .then(roll)
            .catch(function(e) { cerr(e); })
        }

        new QRCode(
          H.elt('#codes .self .code'),
          { text: window.location.href,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H });
        H.elt('#codes .self img[src="images/copy.svg"]')._text = window.location.href;

        H.on('img[src="images/copy.svg"]', 'click', function(ev) {
          clog(ev);
          clog(ev.target);
          clog(ev.target._text);
        });
      });
    </script>
  </body>
</html>

